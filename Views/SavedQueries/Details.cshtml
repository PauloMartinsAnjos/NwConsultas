@model NwConsultas.Models.Database.SavedQuery

@{
    ViewData["Title"] = "Detalhes da Query";
    var queryDefinition = ViewBag.QueryDefinition as NwConsultas.Models.QueryBuilder.QueryDefinition;
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-8">
            <h1><i class="fas fa-info-circle"></i> @Model.Name</h1>
            <p class="text-muted">@Model.Description</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-primary">
                <i class="fas fa-edit"></i> Editar
            </a>
            <a href="@Url.Action("Index")" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Informações Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Criada em</h6>
                    <h5>@Model.CreatedAt.ToString("dd/MM/yyyy")</h5>
                    <small>@Model.CreatedAt.ToString("HH:mm:ss")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Última atualização</h6>
                    <h5>@Model.UpdatedAt.ToString("dd/MM/yyyy")</h5>
                    <small>@Model.UpdatedAt.ToString("HH:mm:ss")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Execuções</h6>
                    <h5>@Model.Executions.Count</h5>
                    <small>Total de execuções</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Exportações</h6>
                    <h5>@Model.Exports.Count</h5>
                    <small>Total de exportações</small>
                </div>
            </div>
        </div>
    </div>

    <!-- SQL Gerado -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-code"></i> SQL Gerado</h5>
        </div>
        <div class="card-body">
            <pre class="bg-dark text-white p-3"><code>@Model.SqlGenerated</code></pre>
        </div>
    </div>

    <!-- Estrutura da Query -->
    @if (queryDefinition != null)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-project-diagram"></i> Estrutura da Query</h5>
            </div>
            <div class="card-body">
                <h6>Tabelas:</h6>
                <ul>
                    @foreach (var table in queryDefinition.Tables)
                    {
                        <li>@table.TableName @(table.TableAlias != null ? $"({table.TableAlias})" : "")</li>
                    }
                </ul>

                @if (queryDefinition.Joins.Any())
                {
                    <h6 class="mt-3">JOINs:</h6>
                    <ul>
                        @foreach (var join in queryDefinition.Joins)
                        {
                            <li>@join.JoinType JOIN @join.RightTable ON @join.LeftTable.@join.LeftColumn = @join.RightTable.@join.RightColumn</li>
                        }
                    </ul>
                }

                @if (queryDefinition.SelectedColumns.Any())
                {
                    <h6 class="mt-3">Colunas Selecionadas:</h6>
                    <ul>
                        @foreach (var column in queryDefinition.SelectedColumns)
                        {
                            <li>@column.TableName.@column.ColumnName @(column.ColumnAlias != null ? $"AS {column.ColumnAlias}" : "")</li>
                        }
                    </ul>
                }

                @if (queryDefinition.Filters.Any())
                {
                    <h6 class="mt-3">Filtros:</h6>
                    <ul>
                        @foreach (var filter in queryDefinition.Filters)
                        {
                            <li>@filter.TableName.@filter.Column @filter.Operator @filter.Value</li>
                        }
                    </ul>
                }
            </div>
        </div>
    }

    <!-- Histórico de Execuções -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-history"></i> Histórico de Execuções</h5>
        </div>
        <div class="card-body">
            @if (Model.Executions.Any())
            {
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tempo (ms)</th>
                                <th>Linhas</th>
                                <th>Status</th>
                                <th>Executado por</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var execution in Model.Executions)
                            {
                                <tr>
                                    <td>@execution.ExecutedAt.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                    <td>@(execution.ExecutionTimeMs ?? 0)</td>
                                    <td>@(execution.RowsReturned ?? 0)</td>
                                    <td>
                                        @if (execution.Success)
                                        {
                                            <span class="badge bg-success">Sucesso</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger" title="@execution.ErrorMessage">Erro</span>
                                        }
                                    </td>
                                    <td>@execution.ExecutedBy</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">Esta query ainda não foi executada.</p>
            }
        </div>
    </div>

    <!-- Histórico de Exportações -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-download"></i> Histórico de Exportações</h5>
        </div>
        <div class="card-body">
            @if (Model.Exports.Any())
            {
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Formato</th>
                                <th>Arquivo</th>
                                <th>Linhas</th>
                                <th>Exportado por</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var export in Model.Exports)
                            {
                                <tr>
                                    <td>@export.ExportedAt.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                    <td><span class="badge bg-info">@export.ExportFormat</span></td>
                                    <td>@export.FileName</td>
                                    <td>@(export.RowCount ?? 0)</td>
                                    <td>@export.ExportedBy</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">Nenhuma exportação realizada ainda.</p>
            }
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
}
